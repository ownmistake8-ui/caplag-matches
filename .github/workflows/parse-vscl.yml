name: –ü–∞—Ä—Å–∏–Ω–≥ VSCL –º–∞—Ç—á–µ–π

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  parse:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_TOKEN }}
      
      - name: –ü–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É VSCL
        run: |
          curl -s -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            'https://www.vscl.ru/team/12482/caplag-esports' > vscl-page.html
      
      - name: –†–∞—Å–ø–∞—Ä—Å–∏—Ç—å –º–∞—Ç—á–∏
        run: |
          node -e '
          const fs = require("fs");
          const html = fs.readFileSync("vscl-page.html", "utf8");
          
          const matches = [];
          
          // –ò—â–µ–º –±–ª–æ–∫ —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ –º–∞—Ç—á–∞–º–∏
          const lastMatchesMatch = html.match(/<div class="team-last-matches">(.*?)<\/div>/s);
          
          if (lastMatchesMatch) {
            const matchesHtml = lastMatchesMatch[1];
            
            // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –º–∞—Ç—á–∏
            const matchRegex = /<div class="last-match-item">(.*?)<\/div>/gs;
            let match;
            
            while ((match = matchRegex.exec(matchesHtml)) !== null) {
              const block = match[1];
              
              const opponentMatch = block.match(/<div class="team-name">(.*?)<\/div>/);
              const scoreMatch = block.match(/<div class="score">(\d+)\s*:\s*(\d+)<\/div>/);
              const mapMatch = block.match(/<div class="map">(.*?)<\/div>/);
              const dateMatch = block.match(/<div class="date">(.*?)<\/div>/);
              
              if (opponentMatch && scoreMatch) {
                const opponent = opponentMatch[1].replace(/<[^>]*>/g, "").trim();
                const ourScore = scoreMatch[1];
                const enemyScore = scoreMatch[2];
                const isWin = parseInt(ourScore) > parseInt(enemyScore);
                const map = mapMatch ? mapMatch[1].trim().toUpperCase() : "N/A";
                let date = dateMatch ? dateMatch[1].trim() : "";
                let timestamp = new Date().toISOString();
                
                // –ü–∞—Ä—Å–∏–º —Ä—É—Å—Å–∫—É—é –¥–∞—Ç—É
                const months = {
                  "—è–Ω–≤": "01", "—Ñ–µ–≤": "02", "–º–∞—Ä": "03", "–∞–ø—Ä": "04",
                  "–º–∞–π": "05", "–∏—é–Ω": "06", "–∏—é–ª": "07", "–∞–≤–≥": "08",
                  "—Å–µ–Ω": "09", "–æ–∫—Ç": "10", "–Ω–æ—è": "11", "–¥–µ–∫": "12"
                };
                
                for (const [month, num] of Object.entries(months)) {
                  if (date.includes(month)) {
                    const dayMatch = date.match(/(\d+)/);
                    const day = dayMatch ? dayMatch[1] : "1";
                    const year = new Date().getFullYear();
                    timestamp = new Date(`${year}-${num}-${day.padStart(2, "0")}`).toISOString();
                    date = `${day.padStart(2, "0")}.${num}`;
                    break;
                  }
                }
                
                matches.push({
                  platform: "VSCL",
                  date: date,
                  timestamp: timestamp,
                  map: map,
                  ourScore: ourScore,
                  enemyScore: enemyScore,
                  opponent: opponent,
                  isWin: isWin,
                  tournament: "VSCL –¢—É—Ä–Ω–∏—Ä"
                });
              }
            }
          }
          
          // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
          matches.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          
          fs.writeFileSync("vscl-matches.json", JSON.stringify(matches, null, 2));
          console.log("‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –º–∞—Ç—á–µ–π:", matches.length);
          '
      
      - name: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add vscl-matches.json
          git diff --quiet && git diff --staged --quiet || git commit -m "ü§ñ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ VSCL –º–∞—Ç—á–µ–π [$(date +'%d.%m.%Y %H:%M')]"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
